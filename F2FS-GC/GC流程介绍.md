## GC的简介以及流程

### GC的含义
GC的全称是garbage collection(垃圾回收)，主要作用就是回收文件系统中无效的数据块。
#### 异地更新策略
在讨论无效块的含义之前先讨论一个问题:
> flash设备的每一个物理块都有一定的刷写次数上限，如果多次地刷写同一个物理块，就会严重影响到这个物理块的寿命，容易导致坏块。

因此闪存文件系统必须考虑到如何将写的压力较为均匀地分配到整个flash设备的每一个块中，因而许多文件系统都采取了**异地更新**策略：
>这个策略的原理是每次写/更新一个块的时候，都会分配一个新的块，将需要写入/修改的数据写入新分配的块，然后更新inode的数据，最后将旧的块抛弃掉。

这个策略可以较好地将写压力分配到不同的块中，进而提升flash设备的寿命。

#### 有效块，无效块的含义
上述提到，异地更新策略会导致旧的数据块被抛弃，因此为了重新利用这些被抛弃的数据块，需要通过一个机制将这些数据块重新变为可用的状态，而这个机制就是**GC机制**。

一般情况下，系统会将数据块分为**有效块，无效块，可用块**。
>有效块：已经被使用的块，如文件中的数据块。
>无效块：被抛弃但是没有回收的块。
>可用块：可以分配给文件的块。

### F2FS的GC流程
#### F2FS的GC机制设计
1. F2FS的gc单位是一个segment(由于 1 sec = 1 seg，因此用seg作为对象)，即512个块，每次触发gc的时候，会根据某种策略，选择一个segment出来，然后对这个segment所有的block，都读取到内存中，然后择机将有效块写到新的segment中。通过这样的操作，就可以得到一个全新的segment，释放了无效块占据的空间。
2. F2FS的GC分为前台GC和后台GC：
> 前台GC(FG_GC)：当磁盘空间不够的时候触发，目的在于快速释放无效块的空间，主要流程是找到segment之后，马上将块回写到磁盘，因此前台GC触发的时候可能会导致卡顿。
> 
> 后台GC(BG_GC)：由gc线程间隔性的触发，目的在于找到segment之后，利用系统的page-writeback机制，找到合适的时机再将块回写，因此对用户影响不大。

#### F2FS的GC流程
1. 以某种策略选择出一个segment，这个segment被称为victim segment，用于GC。
2. 将victim segment管理的512个block读取出来。
3. 根据BG_GC或者FG_GC，对这512个block执行不同的策略，FG_GC就是马上回写，BG_GC就是writeback回写。


















